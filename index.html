<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniAI WebUI</title>
    <!-- Force redeploy: 2026-01-18-v3 -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="fatal-overlay" style="display:none;position:fixed;inset:0;z-index:99999;background:#0b0b0bcc;color:#fff;padding:16px;font:14px/1.45 system-ui;">
      <div style="max-width:900px;margin:0 auto;background:#111;border:1px solid #333;border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.6);">
        <div style="font-weight:700;margin-bottom:8px;">OmniAI failed to start</div>
        <div style="opacity:.8;margin-bottom:12px;">If this persists, open DevTools Console and fix the first error.</div>
        <pre id="fatal-text" style="white-space:pre-wrap;margin:0;"></pre>
      </div>
    </div>
    <script>
    (function(){
      window.__OMNI_DEBUG__ = new URLSearchParams(location.search).has('debug');
      const show = (msg) => {
        const o = document.getElementById('fatal-overlay');
        const t = document.getElementById('fatal-text');
        if (!o || !t) return;
        t.textContent = msg;
        o.style.setProperty('display', 'block', 'important');
        document.documentElement.style.background = '#0b0b0b';
        document.body.style.background = '#0b0b0b';
      };
      window.__SHOW_FATAL__ = show;
      window.addEventListener('error', (e) => {
        const msg = e?.error?.stack || e?.message || String(e);
        show(msg);
      });
      window.addEventListener('unhandledrejection', (e) => {
        const msg = e?.reason?.stack || e?.reason || String(e);
        show(msg);
      });
      setTimeout(() => {
        if (!window.__APP_READY__) show('App did not initialize (timeout). Open DevTools Console for the first error.');
      }, 2500);
    })();
    </script>

    <div id="app" class="app-shell">
        <div id="login-view" class="view hidden">
            <h1>Login to OmniAI</h1>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required aria-label="Username">
                <input type="password" id="password" placeholder="Password" required aria-label="Password">
                <button type="submit">Login</button>
            </form>
            <div id="login-error" class="error hidden"></div>
            <p><a href="#" id="show-register">Need an account? Register</a></p>
        </div>

        <div id="register-view" class="view hidden">
            <h1>Register for OmniAI</h1>
            <form id="register-form">
                <input type="text" id="invite-code" placeholder="Invite Code" required aria-label="Invite Code">
                <input type="text" id="reg-username" placeholder="Username" required aria-label="Username">
                <input type="password" id="reg-password" placeholder="Password" required aria-label="Password">
                <button type="submit">Register</button>
            </form>
            <div id="register-error" class="error hidden"></div>
            <p><a href="#" id="show-login">Already have an account? Login</a></p>
        </div>

        <div id="chat-view" class="view hidden">
            <div id="topbar" class="topbar">
                <div id="topbar-left">
                    <button id="sidebar-toggle" aria-label="Toggle sidebar" class="sidebar-toggle">☰</button>
                    <div id="logo">OmniAI</div>
                    <div id="model-picker" class="model-picker">
                        <select id="provider-select" aria-label="Provider">
                            <option value="">Select Provider</option>
                        </select>
                        <select id="model-select" aria-label="Model" disabled>
                            <option value="">Select Model</option>
                        </select>
                    </div>
                    <div id="run-settings-summary" class="run-settings-summary">Temp: 0.7, Top-P: 1, Max: 1024</div>
                    <div id="connection-indicator" aria-label="Connection status">● Connected</div>
                </div>
                <div id="topbar-right">
                    <button id="settings-btn" aria-label="Settings">⚙</button>
                    <div id="user-info">
                        <span id="user-display"></span>
                        <button id="logout-btn" aria-label="Logout">Logout</button>
                    </div>
                    <a href="#admin" id="admin-link" class="hidden" aria-label="Admin panel">Admin</a>
                </div>
            </div>

            <div class="chat-layout">
                <div id="sidebar" class="sidebar" role="navigation" aria-label="Conversations">
                    <div id="sidebar-header" class="sidebar-header">
                        <button id="new-conversation-btn" aria-label="New conversation">New Chat</button>
                        <input type="text" id="search-conversations" placeholder="Search conversations..." aria-label="Search conversations">
                    </div>
                    <ul id="conversations-list" role="list" aria-label="Conversation threads"></ul>
                </div>

                <main id="main" class="main">
                <div id="chatHeader" class="chat-header">
                    <h1 id="chat-title">New Chat</h1>
                    <div id="chat-actions">
                        <button id="rename-chat-btn" aria-label="Rename conversation">Rename</button>
                        <button id="delete-chat-btn" aria-label="Delete conversation">Delete</button>
                    </div>
                </div>
                <div id="welcome-panel" class="welcome-panel hidden">
                    <div class="welcome-content">
                        <h2>How can I help?</h2>
                        <div class="suggestion-chips">
                            <button class="suggestion-chip">Explain quantum computing</button>
                            <button class="suggestion-chip">Write a Python function</button>
                            <button class="suggestion-chip">Debug my code</button>
                            <button class="suggestion-chip">Plan a project</button>
                            <button class="suggestion-chip">Analyze data trends</button>
                            <button class="suggestion-chip">Design an API</button>
                        </div>
                    </div>
                </div>
                <div id="transcript" class="transcript-wrap" role="log" aria-live="polite" aria-label="Chat transcript"></div>
                <div id="composer" class="composer composer-wrap">
                    <div id="input-area">
                        <textarea id="message-input" placeholder="Type your message..." aria-label="Message input"></textarea>
                        <button id="send-btn" disabled aria-label="Send message">Send</button>
                        <button id="cancel-btn" class="hidden" aria-label="Cancel streaming">Cancel</button>
                        <button id="retry-btn" class="hidden" aria-label="Retry last message">Retry</button>
                    </div>
                    <div id="status-line" class="statusline">
                        <span id="status-text">Ready</span>
                        <span id="elapsed-time"></span>
                        <span id="token-usage"></span>
                    </div>
                </div>
            </main>
            </div>

            <div id="settingsDrawer" class="drawer hidden" role="dialog" aria-labelledby="settings-title" aria-modal="true">
                <div id="settings-header">
                    <h2 id="settings-title">Settings</h2>
                    <button id="close-settings-btn" aria-label="Close settings">×</button>
                </div>
                <div id="settings-content">
                    <!-- Theme & Appearance -->
                    <div class="settings-section">
                        <h3>Appearance</h3>
                        <div class="setting-group">
                            <label for="setting-theme">Theme:</label>
                            <select id="setting-theme">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                                <option value="system">System</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label for="setting-font-size">Font Size:</label>
                            <select id="setting-font-size">
                                <option value="small">Small</option>
                                <option value="medium">Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label for="setting-layout">Layout:</label>
                            <select id="setting-layout">
                                <option value="comfortable">Comfortable</option>
                                <option value="compact">Compact</option>
                            </select>
                        </div>
                    </div>

                    <!-- Chat Behavior -->
                    <div class="settings-section">
                        <h3>Chat Behavior</h3>
                        <div class="setting-group checkbox">
                            <input type="checkbox" id="setting-auto-scroll" checked>
                            <label for="setting-auto-scroll">Auto-scroll to new messages</label>
                        </div>
                        <div class="setting-group checkbox">
                            <input type="checkbox" id="setting-enter-send" checked>
                            <label for="setting-enter-send">Enter to send (Shift+Enter for newline)</label>
                        </div>
                        <div class="setting-group checkbox">
                            <input type="checkbox" id="setting-timestamps">
                            <label for="setting-timestamps">Show message timestamps</label>
                        </div>
                        <div class="setting-group checkbox">
                            <input type="checkbox" id="setting-stream-response" checked>
                            <label for="setting-stream-response">Stream responses (show as they generate)</label>
                        </div>
                    </div>

                    <!-- Generation Settings -->
                    <div class="settings-section">
                        <h3>Generation Settings</h3>
                        <div class="setting-group">
                            <label for="setting-temperature">Temperature:</label>
                            <input type="number" id="setting-temperature" step="0.1" min="0" max="2" placeholder="default">
                        </div>
                        <div class="setting-group">
                            <label for="setting-top-p">Top-P:</label>
                            <input type="number" id="setting-top-p" step="0.01" min="0" max="1" placeholder="default">
                        </div>
                        <div class="setting-group">
                            <label for="setting-max-tokens">Max Tokens:</label>
                            <input type="number" id="setting-max-tokens" min="1" placeholder="default">
                        </div>
                        <button id="reset-generation-settings-btn">Reset to provider defaults</button>
                    </div>

                    <!-- Provider Defaults -->
                    <div class="settings-section">
                        <h3>Provider Defaults</h3>
                        <div class="setting-group checkbox">
                            <input type="checkbox" id="setting-remember-provider" checked>
                            <label for="setting-remember-provider">Remember last used provider</label>
                        </div>
                        <div class="setting-group checkbox">
                            <input type="checkbox" id="setting-remember-model" checked>
                            <label for="setting-remember-model">Remember last used model</label>
                        </div>
                    </div>

                    <!-- Data -->
                    <div class="settings-section">
                        <h3>Data</h3>
                        <button id="clear-history-btn" class="danger-btn">Clear Conversation History</button>
                        <button id="export-data-btn">Export Data</button>
                    </div>
                </div>
            </div>

            <div id="toastHost" aria-live="assertive" aria-atomic="true"></div>
            <div id="modalHost"></div>

            <div id="diagnostics" class="hidden">
                <h3>Diagnostics</h3>
                <button id="test-me">Test /auth/me</button>
                <button id="test-providers">Test /providers</button>
                <div id="diag-results"></div>
            </div>
        </div>

        <div id="admin-view" class="view hidden">
            <header>
                <div id="admin-user-info">
                    <span id="admin-user-display"></span>
                    <button id="admin-logout-btn">Logout</button>
                </div>
                <a href="#chat">Back to Chat</a>
            </header>

            <div id="admin-container">
                <nav id="admin-nav">
                    <button id="admin-users-tab" class="active">Users</button>
                    <button id="admin-invites-tab">Invites</button>
                    <button id="admin-audit-tab">Audit Log</button>
                    <button id="admin-quotas-tab">Quotas</button>
                </nav>

                <main id="admin-main">
                    <div id="admin-users-section" class="admin-section">
                        <h2>Users</h2>
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Display Name</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody"></tbody>
                        </table>
                    </div>

                    <div id="admin-invites-section" class="admin-section hidden">
                        <h2>Invites</h2>
                        <button id="create-invite-btn">Create Invite</button>
                        <table id="invites-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Created By</th>
                                    <th>Used By</th>
                                    <th>Expires</th>
                                    <th>Revoked</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invites-tbody"></tbody>
                        </table>
                    </div>

                    <div id="admin-audit-section" class="admin-section hidden">
                        <h2>Audit Log</h2>
                        <div id="audit-filters">
                            <input type="text" id="audit-q" placeholder="Search target...">
                            <select id="audit-action">
                                <option value="">All Actions</option>
                            </select>
                            <input type="datetime-local" id="audit-since">
                            <button id="audit-search-btn">Search</button>
                        </div>
                        <table id="audit-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Actor</th>
                                    <th>IP</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="audit-tbody"></tbody>
                        </table>
                    </div>

                    <div id="admin-quotas-section" class="admin-section hidden">
                        <h2>User Quotas</h2>
                        <table id="quotas-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Username</th>
                                    <th>Messages/Day</th>
                                    <th>Tokens/Day</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotas-tbody"></tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>

        <div id="error-banner" class="hidden">
            <span id="error-message"></span>
            <button id="dismiss-error">×</button>
        </div>

        <div id="disconnect-banner" class="hidden">
            <span>Disconnected from server. <button id="retry-stream">Retry</button></span>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sse.js"></script>
    <script src="js/store.js"></script>
    <script src="js/render.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/command-palette.js"></script>
    <script src="./js/app.js" defer></script>


</body>
</html>